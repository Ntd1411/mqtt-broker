<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Broker Monitor - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            color: #000000;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .logo {
            font-size: 24px;
        }

        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #000000;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }

        .status.disconnected {
            background: #cccccc;
            box-shadow: 0 0 10px rgba(204, 204, 204, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .header-info {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px 12px;
            background: #000000;
            border-radius: 8px;
            color: white;
        }

        .info-label {
            font-size: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: bold;
            margin-top: 2px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-row {
            display: contents;
        }

        .card-full {
            grid-column: span 2;
        }

        .card-row-span {
            grid-column: span 2;
            grid-row: span 2;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #000000;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .card h2 > span:first-child {
            color: #000000;
        }

        .card-icon {
            font-size: 20px;
            margin-right: 4px;
        }

        .logo {
            font-size: 28px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666666;
            font-size: 15px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #000000;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e5e5e5;
            background: white;
            color: #000000;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #f5f5f5;
            border-color: #000000;
            transform: translateY(-2px);
        }

        .filter-btn.active {
            background: #000000;
            color: white;
            border-color: #000000;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #000000;
        }

        .messages {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
        }

        .messages h2 {
            color: #1e3c72;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .clear-btn, .export-btn, .pause-btn {
            background: #000000;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .clear-btn {
            background: #666666;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .clear-btn:hover, .export-btn:hover, .pause-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .clear-btn:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .pause-btn.paused {
            background: #999999;
        }

        .message-list {
            height: 600px;
            overflow-y: auto;
            padding-right: 8px;
            flex-shrink: 0;
        }

        .card-row-span .message-list {
            height: 100%;
            min-height: 0;
            flex: 1;
        }

        .message-list::-webkit-scrollbar {
            width: 8px;
        }

        .message-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .message-list::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 10px;
        }

        .message-list::-webkit-scrollbar-thumb:hover {
            background: #999999;
        }

        .message {
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #fafafa;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            display: flex;
            gap: 12px;
            align-items: center;
            height: 45px;
            min-height: 45px;
            max-height: 45px;
        }

        .message:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border-color: #cccccc;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message-time {
            color: #9ca3af;
            font-size: 11px;
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-topic {
            color: #ffffff;
            background: #000000;
            font-weight: 700;
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .message-client {
            color: #666666;
            font-size: 13px;
            margin-bottom: 8px;
            font-weight: 500;
            display: none;
        }

        .message-payload {
            color: #1f2937;
            font-family: 'Consolas', 'Courier New', monospace;
            background: #ffffff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            line-height: 1.6;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .client-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .client-list::-webkit-scrollbar {
            width: 6px;
        }

        .client-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .client-list::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 10px;
        }

        .client-item {
            padding: 12px 16px;
            background: #fafafa;
            border-radius: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            color: #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .client-item:hover {
            border-color: #000000;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .client-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #000000;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite;
        }
           

        .client-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .topic-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .topic-list::-webkit-scrollbar {
            width: 6px;
        }

        .topic-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .topic-list::-webkit-scrollbar-thumb {
            background: #cccccc;
            border-radius: 10px;
        }

        .topic-badge {
            background: #000000;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .topic-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .topic-count {
            background: rgba(255, 255, 255, 0.25);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .empty-state {
            text-align: center;
            color: #9ca3af;
            padding: 50px 20px;
            font-style: italic;
            font-size: 15px;
        }

        .publish-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 2px solid #e5e5e5;
        }

        .publish-form.hidden {
            display: none;
        }

        .publish-input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .publish-input:focus {
            outline: none;
            border-color: #000000;
        }

        .publish-input::placeholder {
            color: #999999;
        }

        .publish-btn {
            background: #000000;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .publish-btn:hover {
            background: #333333;
            transform: translateY(-2px);
        }

        .publish-btn:active {
            transform: translateY(0);
        }

        .test-btn {
            background: #666666;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            white-space: nowrap;
        }

        .test-btn:hover {
            background: #555555;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle-form-btn {
            background: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .toggle-form-btn:hover {
            background: #000000;
            color: #ffffff;
            transform: translateY(-2px);
        }

        .toggle-form-btn.active {
            background: #000000;
            color: #ffffff;
        }

        .chart-container {
            height: 200px;
            margin-top: 15px;
        }

        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .card-full {
                grid-column: span 1;
            }

            .card-row-span {
                grid-column: span 1;
                grid-row: span 1;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            header {
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .grid {
                grid-template-columns: 1fr;
            }
            
            .card-full {
                grid-column: span 1;
            }

            .card-row-span {
                grid-column: span 1;
                grid-row: span 1;
            }

            .header-info {
                width: 100%;
                justify-content: space-around;
            }

            .btn-group {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>
                    <i class="fas fa-server logo"></i>
                    MQTT Broker Dashboard
                    <span class="status" id="connectionStatus"></span>
                </h1>
                <div class="header-info">
                    <div class="info-item">
                        <span class="info-label">Uptime</span>
                        <span class="info-value" id="uptime">00:00:00</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Msg/sec</span>
                        <span class="info-value" id="msgRate">0</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid">
            <!-- Row 1-2: Clients, Topics + Messages (span 2 rows) -->
            <div class="card">
                <h2><i class="fas fa-users card-icon"></i>Clients</h2>
                <div class="client-list" id="clientList">
                    <div class="empty-state">Chưa có client nào kết nối</div>
                </div>
            </div>

            <div class="card card-row-span">
                <h2>
                    <span><i class="fas fa-envelope card-icon"></i>Messages</span>
                    <div class="btn-group">
                        <button class="test-btn" onclick="sendTestMessage()"><i class="fas fa-vial"></i> Test</button>
                        <button class="toggle-form-btn" id="toggleFormBtn" onclick="togglePublishForm()"><i class="fas fa-edit"></i> Tùy chỉnh</button>
                        <button class="pause-btn" id="pauseBtn" onclick="togglePause()"><i class="fas fa-pause"></i> Tạm dừng</button>
                        <button class="clear-btn" onclick="clearMessages()"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </div>
                </h2>
                <div class="publish-form hidden" id="publishForm">
                    <input type="text" class="publish-input" id="topicInput" placeholder="Topic (ví dụ: sensor/temp)" />
                    <input type="text" class="publish-input" id="payloadInput" placeholder="Message (ví dụ: 25.5)" />
                    <button class="publish-btn" onclick="publishMessage()"><i class="fas fa-paper-plane"></i> Gửi</button>
                </div>
                <div class="filter-controls">
                    <button class="filter-btn active" onclick="filterMessages('all')">Tất cả</button>
                    <button class="filter-btn" onclick="filterMessages('today')">Hôm nay</button>
                    <button class="filter-btn" onclick="filterMessages('hour')">1 giờ qua</button>
                    <input type="text" class="search-box" id="searchBox" placeholder="Tìm kiếm topic hoặc payload..." onkeyup="searchMessages()">
                </div>
                <div class="message-list" id="messageList">
                    <div class="empty-state">Chưa có message nào</div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-tags card-icon"></i>Topics</h2>
                <div class="topic-list" id="topicList">
                    <div class="empty-state">Chưa có topic nào</div>
                </div>
            </div>

            <!-- Row 3: Thống kê x3 -->
            <div class="card">
                <h2><i class="fas fa-chart-pie card-icon"></i>Tổng quan</h2>
                <div class="stat">
                    <span class="stat-label">Clients đang kết nối</span>
                    <span class="stat-value" id="clientCount">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Topics đang theo dõi</span>
                    <span class="stat-value" id="topicCount">0</span>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-chart-line card-icon"></i>Messages</h2>
                <div class="stat">
                    <span class="stat-label">Tổng messages</span>
                    <span class="stat-value" id="messageCount">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Messages hôm nay</span>
                    <span class="stat-value" id="todayCount">0</span>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-bolt card-icon"></i>Hiệu suất</h2>
                <div class="stat">
                    <span class="stat-label">Messages/giây</span>
                    <span class="stat-value" id="msgRateCard">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Uptime</span>
                    <span class="stat-value" style="font-size: 20px;" id="uptimeCard">00:00:00</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        let ws;
        let reconnectInterval;
        
        let clients = new Set();
        let topics = new Map();
        let messageCount = 0;
        let todayCount = 0;
        let allMessages = [];
        let isPaused = false;
        let startTime = Date.now();
        let messageRateCounter = 0;

        function connectWebSocket() {
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                console.log('Connected to monitor WebSocket');
                document.getElementById('connectionStatus').classList.remove('disconnected');
                clearInterval(reconnectInterval);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (!isPaused) {
                    messageRateCounter++;
                    
                    switch(data.type) {
                        case 'client':
                            clients.add(data.clientId);
                            updateClients();
                            break;
                            
                        case 'clientDisconnect':
                            clients.delete(data.clientId);
                            updateClients();
                            break;
                            
                        case 'publish':
                            addMessage(data);
                            updateTopics(data.topic);
                            break;
                            
                        case 'subscribe':
                            data.topics.forEach(topic => updateTopics(topic));
                            break;
                    }
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('Disconnected from monitor');
                document.getElementById('connectionStatus').classList.add('disconnected');
                reconnectInterval = setInterval(() => {
                    console.log('Attempting to reconnect...');
                    connectWebSocket();
                }, 3000);
            };
        }

        connectWebSocket();

        // Update uptime
        setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsed % 60).padStart(2, '0');
            const timeStr = `${hours}:${minutes}:${seconds}`;
            document.getElementById('uptime').textContent = timeStr;
            document.getElementById('uptimeCard').textContent = timeStr;
        }, 1000);

        // Update message rate
        setInterval(() => {
            const rate = messageRateCounter;
            document.getElementById('msgRate').textContent = rate;
            document.getElementById('msgRateCard').textContent = rate;
            messageRateCounter = 0;
        }, 1000);

        function updateClients() {
            const clientList = document.getElementById('clientList');
            const clientCount = document.getElementById('clientCount');
            
            clientCount.textContent = clients.size;
            
            if (clients.size === 0) {
                clientList.innerHTML = '<div class="empty-state">Chưa có client nào kết nối</div>';
            } else {
                clientList.innerHTML = Array.from(clients).map(id => `
                    <div class="client-item">
                        <span>${id}</span>
                        <span class="client-status"></span>
                    </div>
                `).join('');
            }
        }

        function updateTopics(topic) {
            topics.set(topic, (topics.get(topic) || 0) + 1);
            
            const topicList = document.getElementById('topicList');
            const topicCount = document.getElementById('topicCount');
            
            topicCount.textContent = topics.size;
            
            topicList.innerHTML = Array.from(topics.entries())
                .sort((a, b) => b[1] - a[1])
                .map(([topic, count]) => `
                    <div class="topic-badge">
                        ${topic}
                        <span class="topic-count">${count}</span>
                    </div>
                `).join('');
        }

        function addMessage(data) {
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            
            const today = new Date().toDateString();
            const msgDate = new Date(data.timestamp).toDateString();
            if (today === msgDate) {
                todayCount++;
                document.getElementById('todayCount').textContent = todayCount;
            }
            
            allMessages.unshift(data);
            
            // Giới hạn 500 messages
            if (allMessages.length > 500) {
                allMessages.pop();
            }
            
            renderMessages();
        }

        function renderMessages(filter = 'all', searchTerm = '') {
            const messageList = document.getElementById('messageList');
            
            let filteredMessages = allMessages;
            
            if (filter === 'today') {
                const today = new Date().toDateString();
                filteredMessages = allMessages.filter(msg => 
                    new Date(msg.timestamp).toDateString() === today
                );
            } else if (filter === 'hour') {
                const oneHourAgo = Date.now() - 3600000;
                filteredMessages = allMessages.filter(msg => 
                    new Date(msg.timestamp).getTime() > oneHourAgo
                );
            }
            
            if (searchTerm) {
                filteredMessages = filteredMessages.filter(msg =>
                    msg.topic.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    msg.payload.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            if (filteredMessages.length === 0) {
                messageList.innerHTML = '<div class="empty-state">Không có message nào phù hợp</div>';
                return;
            }
            
            messageList.innerHTML = filteredMessages.map(data => `
                <div class="message">
                    <span class="message-topic">${data.topic}</span>
                    <span class="message-payload">${escapeHtml(data.payload)}</span>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function clearMessages() {
            if (confirm('Bạn có chắc muốn xóa tất cả messages?')) {
                allMessages = [];
                messageCount = 0;
                todayCount = 0;
                document.getElementById('messageCount').textContent = 0;
                document.getElementById('todayCount').textContent = 0;
                document.getElementById('messageList').innerHTML = '<div class="empty-state">Chưa có message nào</div>';
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {
                btn.innerHTML = '<i class="fas fa-play"></i> Tiếp tục';
                btn.classList.add('paused');
            } else {
                btn.innerHTML = '<i class="fas fa-pause"></i> Tạm dừng';
                btn.classList.remove('paused');
            }
        }

        function filterMessages(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMessages(filter, document.getElementById('searchBox').value);
        }

        function searchMessages() {
            const searchTerm = document.getElementById('searchBox').value;
            const activeFilter = document.querySelector('.filter-btn.active');
            const filter = activeFilter ? activeFilter.textContent.trim() : 'all';
            
            let filterType = 'all';
            if (filter === 'Hôm nay') filterType = 'today';
            else if (filter === '1 giờ qua') filterType = 'hour';
            
            renderMessages(filterType, searchTerm);
        }

        function publishMessage() {
            const topic = document.getElementById('topicInput').value.trim();
            const payload = document.getElementById('payloadInput').value.trim();
            
            if (!topic) {
                alert('Vui lòng nhập topic!');
                return;
            }
            
            if (!payload) {
                alert('Vui lòng nhập message!');
                return;
            }
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'publish',
                    topic: topic,
                    payload: payload
                }));
                
                // Clear inputs
                document.getElementById('topicInput').value = '';
                document.getElementById('payloadInput').value = '';
            } else {
                alert('Không thể kết nối đến broker!');
            }
        }

        function sendTestMessage() {
            const timestamp = new Date().toLocaleString('vi-VN');
            const testMessage = {
                type: 'publish',
                topic: 'test/message',
                payload: `Test message at ${timestamp}`
            };
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(testMessage));
            } else {
                alert('Không thể kết nối đến broker!');
            }
        }

        function togglePublishForm() {
            const form = document.getElementById('publishForm');
            const btn = document.getElementById('toggleFormBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-times"></i> Ẩn';
            } else {
                form.classList.add('hidden');
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fas fa-edit"></i> Tùy chỉnh';
            }
        }

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', () => {
            const payloadInput = document.getElementById('payloadInput');
            if (payloadInput) {
                payloadInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        publishMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>
